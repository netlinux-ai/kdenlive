name: Build .deb package

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc \
            /usr/local/graalvm /usr/local/share/powershell \
            /usr/local/lib/node_modules /usr/local/share/chromium \
            /opt/hostedtoolcache
          sudo apt-get clean
          df -h /

      - name: Add KDE Neon repository for KF6/Qt6
        run: |
          curl -fsSL https://archive.neon.kde.org/public.key \
            | sudo gpg --dearmor -o /usr/share/keyrings/neon-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/neon-archive-keyring.gpg] \
            https://archive.neon.kde.org/user noble main" \
            | sudo tee /etc/apt/sources.list.d/kde-neon.list
          # Pin KDE Neon packages higher so KF6/Qt6 are preferred
          cat <<'PIN' | sudo tee /etc/apt/preferences.d/kde-neon
          Package: *
          Pin: origin archive.neon.kde.org
          Pin-Priority: 550
          PIN

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            checkinstall cmake extra-cmake-modules ninja-build \
            qt6-base-dev qt6-svg-dev qt6-multimedia-dev qt6-networkauth-dev \
            qt6-declarative-dev qt6-declarative-private-dev \
            qml6-module-qtqml-workerscript qml6-module-qtquick-window \
            libkf6archive-dev libkf6bookmarks-dev libkf6config-dev \
            libkf6configwidgets-dev libkf6coreaddons-dev libkf6crash-dev \
            libkf6dbusaddons-dev libkf6doctools-dev libkf6filemetadata-dev \
            libkf6guiaddons-dev libkf6iconthemes-dev libkf6kio-dev \
            libkf6newstuff-dev libkf6notifications-dev libkf6notifyconfig-dev \
            libkf6purpose-dev libkf6solid-dev libkf6textwidgets-dev \
            libkf6widgetsaddons-dev libkf6xmlgui-dev \
            frei0r-plugins-dev ffmpeg mediainfo \
            libfftw3-dev libsdl2-dev libxml2-dev \
            libavdevice-dev librtaudio-dev libsox-dev \
            libdv4-dev libmovit-dev librubberband-dev \
            libswscale-dev libebur128-dev libopencv-dev \
            libsamplerate0-dev libvidstab-dev libexif-dev \
            libpango1.0-dev libvorbis-dev \
            libavformat-dev libavcodec-dev libswresample-dev libavutil-dev \
            libarchive-dev libjack-jackd2-dev \
            python3-dev swig libv4l-dev \
            ladspa-sdk qt6-5compat-dev

      - name: Clone and build KDDockWidgets
        run: |
          git clone --depth 1 --branch v2.3.0 \
            https://github.com/KDAB/KDDockWidgets.git
          cmake -B KDDockWidgets/_build KDDockWidgets -GNinja \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DKDDockWidgets_QT6=ON \
            -DKDDockWidgets_FRONTENDS=qtwidgets
          ninja -C KDDockWidgets/_build
          sudo ninja -C KDDockWidgets/_build install

      - name: Clone and build MLT
        run: |
          git clone --depth 1 --branch v7.34.1 --recurse-submodules \
            https://github.com/mltframework/mlt.git
          cmake -B mlt/_build mlt -GNinja \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DMOD_QT=OFF -DMOD_QT6=ON \
            -DMOD_GLAXNIMATE=OFF -DMOD_GLAXNIMATE_QT6=ON \
            -DMOD_KDENLIVE=ON -DSWIG_PYTHON=ON -DMOD_OPENCV=ON
          ninja -C mlt/_build
          sudo ninja -C mlt/_build install
          sudo DESTDIR=/tmp/staging ninja -C mlt/_build install

      - name: Clone Kdenlive
        run: |
          git clone --depth 1 --branch v25.12.2 \
            https://github.com/KDE/kdenlive.git

      - name: Apply NetLinux patches
        run: |
          cd kdenlive
          for p in ../patches/*.patch; do
            [ -f "$p" ] || continue
            echo "Applying $(basename $p)..."
            git apply "$p"
          done

      - name: Build Kdenlive
        run: |
          cmake -B kdenlive/_build kdenlive -GNinja \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DKDE_INSTALL_USE_QT_SYS_PATHS=ON \
            -DRELEASE_BUILD=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF
          ninja -C kdenlive/_build
          sudo DESTDIR=/tmp/staging ninja -C kdenlive/_build install

      - name: Determine version
        id: version
        run: |
          base="25.12.2"
          rev=${{ github.run_number }}
          echo "version=${base}-${rev}netlinux1" >> "$GITHUB_OUTPUT"
          echo "tag=v${base}-${rev}netlinux1" >> "$GITHUB_OUTPUT"

      - name: Package with checkinstall
        run: |
          sudo checkinstall --default \
            --pkgname=kdenlive \
            --pkgversion="${{ steps.version.outputs.version }}" \
            --maintainer="graham@netlinux.co.uk" \
            --requires="libqt6core6t64,libqt6gui6t64,libqt6widgets6t64,\
          libqt6svg6,libqt6multimedia6,libqt6networkauth6,\
          libkf6coreaddons6,libkf6xmlgui6,libkf6kiocore6,\
          libkf6notifications6,libkf6newstuff6,libkf6crash6,\
          libkf6purpose6,libkf6filemetadata6,libkf6iconthemes6,\
          ffmpeg,mediainfo,frei0r-plugins,breeze-icon-theme" \
            --pakdir=. \
            --install=no \
            --fstrans=no \
            bash -c 'cp -a /tmp/staging/usr/* /usr/'

      - name: Repack .deb for reprepro compatibility
        run: |
          DEB=$(ls kdenlive_*.deb)
          sudo chmod 666 "$DEB"
          mkdir repack && cd repack
          ar x "../$DEB"
          for f in *.zst; do
            [ -f "$f" ] || continue
            zstd -d "$f"
            xz "${f%.zst}"
            rm "$f"
          done
          # Add epoch 5: to supersede distro's epoch:4 packages
          mkdir ctrl && cd ctrl
          tar xf ../control.tar.xz
          sed -i 's/^Version: /Version: 5:/' control
          tar cJf ../control.tar.xz ./*
          cd .. && rm -rf ctrl
          rm "../$DEB"
          ar rcs "../$DEB" debian-binary control.tar.xz data.tar.xz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: kdenlive ${{ steps.version.outputs.version }}
          body: |
            Automated build from commit ${{ github.sha }}

            Kdenlive 25.12.2 with bundled MLT 7.34.1 and KDDockWidgets 2.3.0.

            Install: `sudo dpkg -i kdenlive_*.deb`
          files: kdenlive_*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify package repository
        run: |
          sleep 5
          SIGNATURE=$(echo -n '{"repo":"netlinux-ai/kdenlive","tag":"${{ steps.version.outputs.tag }}"}' \
            | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" -binary \
            | xxd -p -c 256)
          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Signature: sha256=${SIGNATURE}" \
            -d '{"repo":"netlinux-ai/kdenlive","tag":"${{ steps.version.outputs.tag }}"}' \
            https://packages.netlinux.co.uk/webhook/update-repo
